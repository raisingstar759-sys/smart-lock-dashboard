<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Lock Dashboard</title>
<link rel="icon" type="image/png" href="assets/logo.png">
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
/* ======================================================
   THEME SYSTEM
====================================================== */
:root {
    --bg: rgba(0,0,0,0.6);
    --bg-card: rgba(0,0,0,0.65);
    --border: #30363d;
    --text: #ffffff;
    --muted: #ccc;

    --btn-main: #238636;
    --btn-alert: #b62324;
    --btn-arm: #d29922;
    --btn-photo: #005cc5;

    --log-bg: rgba(0,0,0,0.75);
}

body.light-theme {
    --bg: rgba(255,255,255,0.5);
    --bg-card: rgba(255,255,255,0.8);
    --border: #d0d7de;
    --text: #000;
    --muted: #444;
    --log-bg: rgba(255,255,255,0.8);
}

/* ======================================================
   GLOBAL STYLING
====================================================== */
body {
    margin: 0;
    background: url("assets/bg.jpg") no-repeat center center fixed;
    background-size: cover;
    color: var(--text);
    font-family: Arial, sans-serif;
    transition: 0.3s;
}

.header {
    padding: 12px 16px;
    background: var(--bg-card);
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.logo {
    height: 40px;
    margin-right: 10px;
}

.theme-btn {
    cursor: pointer;
    font-size: 22px;
    padding: 4px 10px;
    border-radius: 8px;
}

.status-pill {
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 13px;
    color: white;
}
.status-pill.online { background:#238636; }
.status-pill.offline { background:#b62324; }

.container { padding: 16px; }
.row { display: flex; gap: 16px; flex-wrap: wrap; justify-content: center; }

.card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    padding: 16px;
    border-radius: 12px;
    width: 100%;
    max-width: 420px;
    text-align: center;
}

/* ======================================================
   BUTTONS
====================================================== */
button {
    width: 100%;
    max-width: 280px;
    padding: 12px;
    margin: 8px auto;
    border: none;
    border-radius: 10px;
    font-size: 15px;
    cursor: pointer;
    color: white;
    display: block;
}
.btn-main { background: var(--btn-main); }
.btn-arm { background: var(--btn-arm); }
.btn-alert { background: var(--btn-alert); }
.btn-photo { background: var(--btn-photo); }

/* ======================================================
   IMAGES
====================================================== */
.image-wrapper { text-align: center; }
.alertImg, .reqImg {
    width: 100%;
    max-width: 300px;
    margin: auto;
    display: block;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: #000;
}

/* ======================================================
   GALLERY GRID
====================================================== */
.gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 12px;
    padding: 10px 0;
}

.gallery-grid img {
    width: 100%;
    border-radius: 8px;
    border: 1px solid var(--border);
}

/* ======================================================
   POPUP
====================================================== */
.popup {
    position: fixed;
    top: -120px;
    left: 50%;
    transform: translateX(-50%);
    background: #ff4444;
    color: white;
    padding: 14px 22px;
    border-radius: 12px;
    font-size: 17px;
    font-weight: bold;
    opacity: 0;
    transition: 0.4s;
    z-index: 10000;
}
.popup.show { top: 25px; opacity: 1; }

/* ======================================================
   LOGS
====================================================== */
#logs {
    background: var(--log-bg);
    color: var(--text);
    padding: 10px;
    height: 220px;
    border-radius: 10px;
    border: 1px solid var(--border);
    overflow-y: auto;
    font-size: 13px;
}

/* ======================================================
   RESPONSIVE (Mobile)
====================================================== */
@media(max-width: 768px) {

    .header {
        flex-direction: column;
        text-align: center;
        gap: 10px;
    }

    .row {
        flex-direction: column;
        align-items: center;
    }

    button {
        width: 100%;
        max-width: 300px;
    }

    .card {
        width: 100%;
        max-width: 360px;
    }
}
</style>
</head>

<body>

<!-- POPUP -->
<div id="popup" class="popup"></div>

<!-- HEADER -->
<div class="header">
    <div style="display:flex; align-items:center;">
        <img src="assets/logo.png" class="logo">
        <strong>SMART LOCK DASHBOARD</strong>
    </div>
    <div style="display:flex; gap:16px; align-items:center;">
        <span class="theme-btn" id="themeBtn">ðŸŒ™</span>
        <span id="devStatus" class="status-pill offline">OFFLINE</span>
    </div>
</div>

<div class="container">

    <div class="row">

        <!-- Controls -->
        <div class="card">
            <h2>Controls</h2>

            <button class="btn-main" onclick="sendCmd('LOCK')">LOCK</button>
            <button class="btn-main" onclick="sendCmd('UNLOCK')">UNLOCK</button>

            <button class="btn-arm" onclick="sendCmd('START_ALERT')">START ALERT</button>
            <button class="btn-alert" onclick="sendCmd('STOP_ALERT')">STOP ALERT</button>

            <button class="btn-photo" onclick="sendCmd('REQ_PHOTO')">REQUEST PHOTO</button>

            <hr style="border-color:var(--border);">

            <div><b>Lock:</b> <span id="lockStatus">UNKNOWN</span></div>
            <div><b>Alert:</b> <span id="alertStatus">IDLE</span></div>
        </div>

        <!-- Alert Image -->
        <div class="card">
            <h2>Alert Snapshot</h2>
            <div class="image-wrapper">
                <img id="alertImg" class="alertImg">
                <button class="btn-photo" onclick="downloadImage('alertImg','alert')">Download</button>
            </div>
        </div>

        <!-- Requested Photo -->
        <div class="card">
            <h2>Requested Photo</h2>
            <div class="image-wrapper">
                <img id="reqImg" class="reqImg">
                <button class="btn-photo" onclick="downloadImage('reqImg','request')">Download</button>
            </div>
        </div>
    </div>

    <!-- IMAGE HISTORY -->
    <div class="card">
        <h2>Image History (Latest 20)</h2>
        <button class="btn-alert" onclick="clearHistory()">Clear History</button>
        <div id="history" class="gallery-grid"></div>
    </div>

    <!-- LOGS -->
    <div class="card">
        <h2>Logs</h2>
        <div id="logs"></div>
    </div>
</div>

<script>
/* MQTT */
const client = mqtt.connect("ws://3.107.229.251:9001");
let connected = false;

/* Buffers */
let imgBuf={};
let imgMeta={};

let suppressLockPopup = false;

/* POPUP */
function popup(msg,color="#ff4444"){
    const p=document.getElementById("popup");
    p.innerHTML=msg;
    p.style.background=color;
    p.classList.add("show");
    setTimeout(()=>p.classList.remove("show"),3000);
}

/* SOUND */
function play(id){
    const a=document.getElementById(id);
    a.currentTime=0;
    a.play().catch(()=>{});
}

/* LOG */
function log(t){
    const box=document.getElementById("logs");
    box.innerHTML+=`<div class='log-line'>${t}</div>`;
    box.scrollTop=box.scrollHeight;
}

/* THEME */
document.getElementById("themeBtn").onclick=()=>{
    document.body.classList.toggle("light-theme");
    document.getElementById("themeBtn").innerText=
        document.body.classList.contains("light-theme")?"â˜€ï¸":"ðŸŒ™";
};

/* HISTORY */
function addToHistory(img, type){
    let list = JSON.parse(localStorage.getItem("imgHistory") || "[]");
    list.unshift({ type:type, src:img, time:new Date().toLocaleString() });
    if(list.length > 20) list = list.slice(0,20);
    localStorage.setItem("imgHistory", JSON.stringify(list));
    updateHistory();
}
function updateHistory(){
    const box=document.getElementById("history");
    box.innerHTML="";
    let list = JSON.parse(localStorage.getItem("imgHistory") || "[]");
    list.forEach(item=>{
        box.innerHTML+=`
            <div>
                <img src="${item.src}">
                <small>${item.time}</small>
            </div>`;
    });
}
function clearHistory(){
    localStorage.removeItem("imgHistory");
    updateHistory();
    popup("History Cleared","#b62324");
}

/* DOWNLOAD */
function downloadImage(id, name){
    const img=document.getElementById(id).src;
    if(!img) return;
    const a=document.createElement("a");
    a.href=img;
    a.download = name + "_" + Date.now() + ".jpg";
    a.click();
}

/* MQTT EVENTS */
client.on("connect",()=>{
    connected=true;
    document.getElementById("devStatus").className="status-pill online";
    document.getElementById("devStatus").textContent="ONLINE";
    popup("Device Connected âš¡","#22bb33");
    client.subscribe("smart_lock/pub");
});

client.on("close",()=>{
    connected=false;
    document.getElementById("devStatus").className="status-pill offline";
    document.getElementById("devStatus").textContent="OFFLINE";
    popup("Device Offline ðŸ”Œ","#b62324");
});

client.on("message",(topic,msg)=>{
    const raw = msg.toString();
    log("RX: " + raw);

    let j; try{ j=JSON.parse(raw);}catch{return;}

    if(j.IMG_START){
        imgBuf[j.IMG_START]=[];
        imgMeta[j.IMG_START]=j;
        return;
    }
    if(j.IMG_DATA){
        imgBuf[j.IMG_DATA][j.seq]=j.data;
        return;
    }
    if(j.IMG_END){
        const id=j.IMG_END;
        const meta=imgMeta[id];
        const base64=imgBuf[id].join("");
        const full="data:image/jpeg;base64,"+base64;

        if(meta.type==="ALERT"){
            suppressLockPopup=true;
            setTimeout(()=>suppressLockPopup=false,2500);
            document.getElementById("alertImg").src=full;
            popup("ðŸš¨ Someone is trying to open the door!","#ff2222");
            addToHistory(full,"ALERT");
        } else {
            document.getElementById("reqImg").src=full;
            popup("ðŸ“¸ Photo Captured","#2255ff");
        }

        delete imgBuf[id];
        delete imgMeta[id];
        return;
    }

    if(j.LOCK){
        document.getElementById("lockStatus").textContent=j.LOCK;
        if(!suppressLockPopup){
            popup(j.LOCK==="LOCKED"?"ðŸ”’ Locked":"ðŸ”“ Unlocked",
                j.LOCK==="LOCKED"?"#22bb33":"#2266ff");
        }
    }

    if(j.ALERT){
        document.getElementById("alertStatus").textContent=j.ALERT;
        if(j.ALERT==="ARMED") popup("âš  Alert Mode Enabled","#ffaa00");
        if(j.ALERT==="STOP") popup("ðŸŸ¡ Alert Stopped","#cccc00");
    }
});

/* SEND COMMAND */
function sendCmd(cmd){
    if(!connected){
        popup("Device Offline","#b62324");
        return;
    }
    client.publish("smart_lock/sub",cmd);
}

/* Load history at startup */
window.onload = updateHistory;
</script>

</body>
</html>
